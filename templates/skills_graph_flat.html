{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/skill-panel.css">
<style>
    #cy {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    #loading {
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        text-align: center;
        margin-top: -0.5em;
        font-size: 2em;
        color: #6c757d;
        z-index: 1000;
    }

    #loading.loaded { display: none; }

    .controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls button {
        margin: 5px;
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .controls button:hover { background-color: #0056b3; }
    .controls button:disabled { background-color: #6c757d; cursor: not-allowed; }

    /* Adjust for skill panel */
    .skill-panel-visible #cy {
        right: 400px;
    }

    @media (max-width: 768px) {
        .skill-panel-visible #cy {
            right: 0;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="controls">
                <button id="reset-view">Reset View</button>
                <button id="layout-cose">Auto Layout</button>
                <button id="toggle-labels">Toggle Labels</button>
                <button id="path-da-agents">Path: Data Analyst â†’ AI Agents</button>
            </div>
            <div id="cy"></div>
            <div id="loading"><span class="spinner-border" role="status"></span> Loading flat graph...</div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="/static/skill-panel.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    let cy;
    let labelsVisible = true;

    async function init() {
        try {
            const response = await fetch('/api/roadmap-flat');
            const data = await response.json();

            const styleText = await (await fetch('/static/skills-graph.cycss')).text();

            document.getElementById('loading').classList.add('loaded');

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: data.elements,
                style: styleText,
                layout: { name: 'cose' },
            });

            bind();
        } catch (e) {
            document.getElementById('loading').innerText = 'Error: ' + (e && e.message ? e.message : e);
        }
    }

    function bind() {
        document.getElementById('reset-view').addEventListener('click', () => cy.fit());
        document.getElementById('layout-cose').addEventListener('click', () => cy.layout({ name: 'cose' }).run());
        document.getElementById('toggle-labels').addEventListener('click', () => {
            labelsVisible = !labelsVisible;
            cy.style().selector('node').style('label', labelsVisible ? 'data(name)' : '').update();
        });

        // Reusable function to highlight path between any two skills
        async function highlightPathBetweenSkills(startSkill = 'data analyst', targetSkill = 'ai agents') {
            try {
                console.log(`ðŸŽ¯ Highlighting path from "${startSkill}" to "${targetSkill}"`);
                const res = await fetch('/api/skill-path?start=' + encodeURIComponent(startSkill) + '&end=' + encodeURIComponent(targetSkill));
                const { path, edges } = await res.json();
                if (!path || path.length === 0) {
                    console.log(`âŒ No path found from "${startSkill}" to "${targetSkill}"`);
                    return;
                }

                // Reset previous state
                cy.elements().removeClass('highlighted not-path');
                cy.nodes().unselect();

                // Dim everything by default
                cy.elements().addClass('not-path');

                // Extract IDs from path objects (handle both object and string formats)
                const pathIds = path.map(item => typeof item === 'object' ? item.id : item);

                pathIds.forEach(id => {
                    const n = cy.getElementById(id);
                    if (n) {
                        n.addClass('highlighted');
                        n.removeClass('not-path');
                        n.select();
                    }
                });

                edges.forEach(e => {
                    const sourceId = typeof e.source === 'object' ? e.source.id : e.source;
                    const targetId = typeof e.target === 'object' ? e.target.id : e.target;
                    const edgeId = `${sourceId}-${targetId}`;
                    const ed = cy.getElementById(edgeId);
                    if (ed) {
                        ed.addClass('highlighted');
        					ed.removeClass('not-path');
                    }
                });

                const highlighted = cy.elements('.highlighted');
                if (highlighted && highlighted.length > 0) {
                    cy.fit(highlighted, 80);
                }

                // Log path for debugging
                console.log(`âœ… Path from "${startSkill}" to "${targetSkill}":`, path);
            } catch (e) {
                console.error('Failed to fetch path', e);
            }
        }

        // Make function globally available for external use
        window.highlightPathBetweenSkills = highlightPathBetweenSkills;

        // Path button with default values
        document.getElementById('path-da-agents').addEventListener('click', async () => {
            await highlightPathBetweenSkills(); // Uses default values: 'data analyst' and 'ai agents'
        });

        // Add click handler for nodes to show skill panel
        cy.on('tap', 'node', function(evt) {
            const node = evt.target;
            const skillId = node.data('id');
            const skillName = node.data('name');
            
            if (skillId) {
                // Show skill panel
                window.skillPanel.show(skillId);
                
                // Add class to body to adjust layout
                document.body.classList.add('skill-panel-visible');
                
                // Listen for panel close to remove class
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const panel = document.getElementById('skill-panel');
                            if (panel && panel.classList.contains('hidden')) {
                                document.body.classList.remove('skill-panel-visible');
                                observer.disconnect();
                            }
                        }
                    });
                });
                
                const panel = document.getElementById('skill-panel');
                if (panel) {
                    observer.observe(panel, { attributes: true });
                }
            }
        });

        // Add hover effects for nodes
        cy.on('mouseover', 'node', function(evt) {
            const node = evt.target;
            node.style('background-color', '#e3f2fd');
            node.style('border-color', '#2196f3');
        });

        cy.on('mouseout', 'node', function(evt) {
            const node = evt.target;
            node.style('background-color', '');
            node.style('border-color', '');
        });
    }

    init();
});
</script>
{% endblock %}
{% endblock %}



