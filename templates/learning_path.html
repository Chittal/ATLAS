{% extends "base.html" %}

{% block title %}Learning Path: {{ start_skill }} → {{ end_skill }}{% endblock %}

{% block head %}
<style>
    .learning-path-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: hsl(var(--background));
    }

    .learning-path-header {
        background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary) / 0.8) 100%);
        color: hsl(var(--primary-foreground));
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    .learning-path-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-align: center;
        background: linear-gradient(135deg, hsl(var(--primary-foreground)) 0%, hsl(var(--primary-foreground) / 0.8) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .learning-path-subtitle {
        font-size: 1.25rem;
        opacity: 0.9;
        text-align: center;
        margin-bottom: 2rem;
        color: hsl(var(--primary-foreground) / 0.8);
    }

    .learning-path-nav {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .nav-button {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: hsl(var(--primary-foreground));
        padding: 0.75rem 1.5rem;
        border-radius: calc(var(--radius) + 4px);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-button:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.3);
        color: hsl(var(--primary-foreground));
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .learning-path-content {
        flex: 1;
        position: relative;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .graph-container {
        width: 100%;
        max-width: 1000px;
        height: 500px;
        background: hsl(var(--card));
        border-radius: calc(var(--radius) + 4px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        border: 1px solid hsl(var(--border));
        position: relative;
        overflow: hidden;
        margin-top: 2rem;
    }

    #cy {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: hsl(var(--muted));
        border: 1px solid hsl(var(--border));
    }

    .learning-path-info {
        background: hsl(var(--card));
        border-radius: calc(var(--radius) + 4px);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        border: 1px solid hsl(var(--border));
        max-width: 800px;
        width: 100%;
    }

    .path-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: hsl(var(--muted));
        border-radius: calc(var(--radius) - 2px);
        border: 1px solid hsl(var(--border));
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: hsl(var(--primary));
        display: block;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: hsl(var(--muted-foreground));
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
    }

    .path-description {
        text-align: center;
        color: hsl(var(--foreground));
        font-size: 1.125rem;
        line-height: 1.6;
        margin-bottom: 1.5rem;
    }

    .path-skills {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }

    .skill-badge {
        background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary) / 0.8) 100%);
        color: hsl(var(--primary-foreground));
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .skill-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .skill-arrow {
        color: hsl(var(--primary));
        font-size: 1.25rem;
        font-weight: 600;
    }

    #loading {
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        text-align: center;
        margin-top: -0.5em;
        font-size: 2em;
        color: hsl(var(--muted-foreground));
        z-index: 1000;
    }

    #loading.loaded { display: none; }

    .learning-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .action-button {
        background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary) / 0.8) 100%);
        color: hsl(var(--primary-foreground));
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: calc(var(--radius) + 4px);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        color: hsl(var(--primary-foreground));
        text-decoration: none;
    }

    .action-button.secondary {
        background: linear-gradient(135deg, hsl(var(--secondary)) 0%, hsl(var(--secondary) / 0.8) 100%);
        color: hsl(var(--secondary-foreground));
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    .action-button.secondary:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        color: hsl(var(--secondary-foreground));
    }

    /* Expanded Learning Nodes Styles */
    .expanded-learning-nodes {
        width: 100%;
        max-width: 1200px;
        margin-top: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 1px solid #dee2e6;
        overflow: hidden;
        display: none;
        z-index: 1000;
        position: relative;
    }

    .expanded-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .expanded-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .close-expanded {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-expanded:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

     .learning-nodes-grid {
         padding: 30px;
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
         gap: 20px;
     }

     .learning-nodes-graph-container {
         height: 400px;
         background: #f8f9fa;
         border: 1px solid #dee2e6;
         border-radius: 8px;
         margin: 20px 30px;
         position: relative;
         overflow: hidden;
     }

     #learning-nodes-cy {
         position: absolute;
         left: 0;
         top: 0;
         right: 0;
         bottom: 0;
         background: #f8f9fa;
     }

     #learning-nodes-loading {
         position: absolute;
         left: 0;
         top: 50%;
         width: 100%;
         text-align: center;
         margin-top: -0.5em;
         font-size: 1.5em;
         color: #6c757d;
         z-index: 1000;
     }

     #learning-nodes-loading.loaded { display: none; }

     /* Filter Controls Styles */
     .learning-nodes-filters {
         padding: 20px 30px;
         background: #f8f9fa;
         border-bottom: 1px solid #dee2e6;
         display: flex;
         flex-wrap: wrap;
         gap: 15px;
         align-items: center;
         justify-content: space-between;
     }

     .filter-group {
         display: flex;
         align-items: center;
         gap: 10px;
     }

     .filter-label {
         font-weight: 600;
         color: #495057;
         font-size: 14px;
         white-space: nowrap;
     }

     .filter-select, .filter-input {
         padding: 8px 12px;
         border: 2px solid #e9ecef;
         border-radius: 8px;
         font-size: 14px;
         background: white;
         transition: all 0.3s ease;
         min-width: 120px;
     }

     .filter-select:focus, .filter-input:focus {
         outline: none;
         border-color: #667eea;
         box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
     }

     .filter-input {
         min-width: 200px;
     }

     .filter-buttons {
         display: flex;
         gap: 8px;
     }

     .filter-btn {
         padding: 8px 16px;
         border: none;
         border-radius: 20px;
         font-size: 14px;
         font-weight: 500;
         cursor: pointer;
         transition: all 0.3s ease;
         display: flex;
         align-items: center;
         gap: 5px;
     }

     .filter-btn.primary {
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
     }

     .filter-btn.primary:hover {
         transform: translateY(-1px);
         box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
     }

     .filter-btn.secondary {
         background: #6c757d;
         color: white;
     }

     .filter-btn.secondary:hover {
         background: #5a6268;
         transform: translateY(-1px);
         box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
     }

     .filter-btn.danger {
         background: #dc3545;
         color: white;
     }

     .filter-btn.danger:hover {
         background: #c82333;
         transform: translateY(-1px);
         box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
     }

     .filter-results {
         padding: 10px 30px;
         background: #e9ecef;
         border-bottom: 1px solid #dee2e6;
         font-size: 14px;
         color: #6c757d;
         display: flex;
         justify-content: space-between;
         align-items: center;
     }

     .filter-results.hidden {
         display: none;
     }

     .no-results {
         padding: 40px;
         text-align: center;
         color: #6c757d;
         font-style: italic;
     }

     .no-results.hidden {
         display: none;
     }

     .learning-nodes-list-container {
         padding: 30px;
         display: flex;
         flex-direction: column;
         gap: 15px;
         max-height: 500px;
         overflow-y: auto;
         z-index: 1000;
         position: relative;
     }

     .learning-node-item {
         display: flex;
         align-items: center;
         background: white;
         border: 2px solid #e9ecef;
         border-radius: 12px;
         padding: 15px 20px;
         transition: all 0.3s ease;
         gap: 15px;
         position: relative;
     }

     .learning-node-item:hover {
         border-color: #667eea;
         transform: translateY(-2px);
         box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
     }

     .learning-node-item[data-depth="0"] {
         border-left: 4px solid #28a745;
     }

     .learning-node-item[data-depth="1"] {
         border-left: 4px solid #ffc107;
     }

     .learning-node-item[data-depth="2"] {
         border-left: 4px solid #dc3545;
     }

     .learning-node-item.completed {
         background: #f8f9fa;
         border-color: #28a745;
         opacity: 0.8;
     }

     .learning-node-item.completed .node-name {
         text-decoration: line-through;
         color: #6c757d;
     }

     .learning-node-item.completed .node-step {
         background: #28a745;
         color: white;
     }

     .completion-checkbox {
         width: 20px;
         height: 20px;
         border: 2px solid #667eea;
         border-radius: 4px;
         background: white;
         cursor: pointer;
         transition: all 0.3s ease;
         flex-shrink: 0;
         display: flex;
         align-items: center;
         justify-content: center;
         position: relative;
     }

     .completion-checkbox:hover {
         border-color: #28a745;
         background: #f8f9fa;
     }

     .completion-checkbox.checked {
         background: #28a745;
         border-color: #28a745;
         color: white;
     }

     .completion-checkbox.checked::after {
         content: '✓';
         font-size: 14px;
         font-weight: bold;
         color: white;
     }

     .node-step {
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
         width: 40px;
         height: 40px;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         font-weight: bold;
         font-size: 16px;
         flex-shrink: 0;
     }

     .node-content {
         flex: 1;
         min-width: 0;
     }

     .node-name {
         font-size: 1.1rem;
         font-weight: 600;
         color: #333;
         margin-bottom: 5px;
     }

     .node-description {
         color: #6c757d;
         font-size: 14px;
         line-height: 1.4;
         margin-bottom: 8px;
     }


     .node-actions {
         display: flex;
         gap: 8px;
         flex-shrink: 0;
     }

     /* Resources Modal Styles */
     .resources-modal {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.5);
         display: flex;
         align-items: center;
         justify-content: center;
         z-index: 10000;
         opacity: 0;
         transform: scale(0.9);
         transition: all 0.3s ease;
     }

     .resources-modal-content {
         background: white;
         border-radius: 15px;
         max-width: 600px;
         width: 90%;
         max-height: 80vh;
         overflow: hidden;
         box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
     }

     .resources-modal-header {
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
         padding: 20px;
         display: flex;
         justify-content: space-between;
         align-items: center;
     }

     .resources-modal-header h3 {
         margin: 0;
         font-size: 1.3rem;
         font-weight: 600;
     }

     .close-resources {
         background: rgba(255, 255, 255, 0.2);
         border: none;
         color: white;
         padding: 8px;
         border-radius: 50%;
         cursor: pointer;
         transition: all 0.3s ease;
     }

     .close-resources:hover {
         background: rgba(255, 255, 255, 0.3);
         transform: scale(1.1);
     }

     .resources-list {
         padding: 20px;
         max-height: 60vh;
         overflow-y: auto;
     }

     .resource-item {
         display: flex;
         align-items: center;
         justify-content: space-between;
         padding: 15px;
         border: 1px solid #e9ecef;
         border-radius: 8px;
         margin-bottom: 10px;
         transition: all 0.3s ease;
     }

     .resource-item:hover {
         border-color: #667eea;
         transform: translateY(-2px);
         box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
     }

     .resource-info {
         flex: 1;
     }

     .resource-title {
         font-size: 1rem;
         font-weight: 600;
         color: #333;
         margin-bottom: 5px;
     }

     .resource-type {
         font-size: 0.9rem;
         color: #6c757d;
         background: #f8f9fa;
         padding: 2px 8px;
         border-radius: 12px;
         display: inline-block;
     }

     .resource-actions {
         margin-left: 15px;
     }

     .resource-link {
         background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
         color: white;
         text-decoration: none;
         padding: 8px 16px;
         border-radius: 20px;
         font-size: 14px;
         font-weight: 500;
         display: inline-flex;
         align-items: center;
         gap: 5px;
         transition: all 0.3s ease;
     }

     .resource-link:hover {
         transform: translateY(-1px);
         box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
         color: white;
         text-decoration: none;
     }

    .learning-node-card {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .learning-node-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .learning-node-card[data-depth="0"] {
        border-left: 4px solid #28a745;
    }

    .learning-node-card[data-depth="1"] {
        border-left: 4px solid #ffc107;
    }

    .learning-node-card[data-depth="2"] {
        border-left: 4px solid #dc3545;
    }

    .node-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .node-number {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }

    .node-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        flex: 1;
    }

    .node-depth {
        background: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .node-description {
        color: #6c757d;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .node-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

     .action-btn {
         padding: 8px 16px;
         border: none;
         border-radius: 20px;
         font-size: 14px;
         font-weight: 500;
         cursor: pointer;
         transition: all 0.3s ease;
         flex: 1;
         min-width: 120px;
         display: inline-block;
         text-align: center;
         z-index: 1000;
         position: relative;
     }

    .action-btn.primary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

     .action-btn.primary:hover {
         transform: translateY(-1px);
         box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
         cursor: pointer;
     }

     .action-btn.primary:active {
         transform: translateY(0);
         cursor: pointer;
     }

    .action-btn.secondary {
        background: #6c757d;
        color: white;
    }

    .action-btn.secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .learning-path-title {
            font-size: 1.5rem;
        }
        
        .learning-path-subtitle {
            font-size: 1rem;
        }
        
        .learning-path-content {
            padding: 10px;
        }
        
        .learning-path-info {
            padding: 20px;
        }
        
        .path-stats {
            flex-direction: column;
            gap: 15px;
        }
        
        .learning-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .action-button {
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }
        
        .learning-nodes-grid {
            grid-template-columns: 1fr;
            padding: 20px;
        }
        
        .expanded-header {
            padding: 15px;
        }
        
        .expanded-header h3 {
            font-size: 1.2rem;
        }
        
        .learning-nodes-filters {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
            padding: 15px 20px;
        }
        
        .filter-group {
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
        }
        
        .filter-label {
            text-align: left;
        }
        
        .filter-select, .filter-input {
            width: 100%;
            min-width: unset;
        }
        
        .filter-buttons {
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            flex: 1;
            min-width: 100px;
            justify-content: center;
        }
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: hsl(var(--card));
        margin: 5% auto;
        padding: 0;
        border: 1px solid hsl(var(--border));
        border-radius: 0.75rem;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid hsl(var(--border));
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: hsl(var(--foreground));
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: hsl(var(--muted-foreground));
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: hsl(var(--muted));
        color: hsl(var(--foreground));
    }

    .note-form {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        color: hsl(var(--foreground));
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid hsl(var(--border));
        border-radius: 0.5rem;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 0.875rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: hsl(var(--ring));
        box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .form-help {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .checkbox-label input[type="checkbox"] {
        margin-right: 0.5rem;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding: 1.5rem;
        border-top: 1px solid hsl(var(--border));
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-primary {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }

    .btn-primary:hover {
        background: hsl(var(--primary) / 0.9);
    }

    .btn-secondary {
        background: hsl(var(--secondary));
        color: hsl(var(--secondary-foreground));
        border: 1px solid hsl(var(--border));
    }

    .btn-secondary:hover {
        background: hsl(var(--secondary) / 0.8);
    }
</style>
{% endblock %}

{% block body %}
<div class="learning-path-container">
    <!-- Header Section -->
    <div class="learning-path-header">
        <div class="container">
            <h1 class="learning-path-title">🎯 Your Learning Journey</h1>
            <p class="learning-path-subtitle" id="path-subtitle">Loading your personalized learning path...</p>
            
            <div class="learning-path-nav">
                <a href="{{ url_for_prefix('/') }}" class="nav-button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                    Back to Full Map
                </a>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="learning-path-content">
        <div class="container">
            <!-- Path Information -->
            <div class="learning-path-info card animate-in fade-in" id="path-info">
                <div class="path-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="total-skills">-</span>
                        <span class="stat-label">Skills</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="estimated-time">-</span>
                        <span class="stat-label">Estimated Time</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="difficulty">-</span>
                        <span class="stat-label">Difficulty</span>
                    </div>
                </div>
                
                <div class="path-description" id="path-description">
                    Your personalized learning path will appear here...
                </div>
                
                <div class="path-skills" id="path-skills">
                    <!-- Skills will be populated here -->
                </div>
                
                <div class="learning-actions">
                    <button class="action-button btn btn-primary btn-lg" id="begin-learning-action">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L13.09 8.26L12 2Z"/>
                        </svg>
                        Begin Learning
                    </button>
                    <button class="action-button btn btn-outline btn-lg" id="create-note-action" onclick="openNotesPage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Create Note
                    </button>
                    <button class="action-button secondary btn btn-secondary btn-lg" id="ask-questions-action">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z"/>
                        </svg>
                        Ask Questions
                    </button>
                </div>
            </div>

            <!-- Graph Visualization -->
            <div class="graph-container card animate-in slide-in-from-bottom">
                <div id="cy"></div>
                <div id="loading" class="flex flex-col items-center justify-center h-full">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                    <div class="text-muted-foreground">Loading your learning path...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="note-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Create New Note</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="note-form" class="note-form">
                <div class="form-group">
                    <label for="note-title-input">Title</label>
                    <input type="text" id="note-title-input" class="form-input" placeholder="Enter note title..." required>
                </div>
                <div class="form-group">
                    <label for="note-content-input">Content</label>
                    <textarea id="note-content-input" class="form-textarea" placeholder="Enter your note content..." rows="6" required></textarea>
                </div>
                <div class="form-group">
                    <label for="note-tags-input">Tags</label>
                    <input type="text" id="note-tags-input" class="form-input" placeholder="Enter tags separated by commas (e.g., Python, Programming, Learning)">
                    <small class="form-help">Separate multiple tags with commas</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="note-favorite-input">
                        <span class="checkmark"></span>
                        Mark as favorite
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-note-btn">Save Note</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    let cy;
    let pathData = null; // Store path data globally
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const startSkill = urlParams.get('start') || 'data analyst';
    const endSkill = urlParams.get('end') || 'ai agents';
    const roadmapPathId = urlParams.get('user_roadmap_path_id');
    
    // If we have a roadmap path ID from the URL, set it immediately
    if (roadmapPathId) {
        setCurrentUserRoadmapPathId(roadmapPathId);
        console.log('📊 User roadmap path ID set from URL:', roadmapPathId);
    }
    
    // Update page title and subtitle
    if (roadmapPathId) {
        document.getElementById('path-subtitle').textContent = 'Saved Roadmap';
        document.title = 'Learning Path: Saved Roadmap';
    } else {
        document.getElementById('path-subtitle').textContent = `${startSkill} → ${endSkill}`;
        document.title = `Learning Path: ${startSkill} → ${endSkill}`;
    }
    
    async function init() {
        try {
            // Fetch path data - use user_roadmap_path_id if available, otherwise use start/end
            let pathUrl;
            if (roadmapPathId) {
                pathUrl = `/api/skill-path?user_roadmap_path_id=${encodeURIComponent(roadmapPathId)}`;
            } else {
                pathUrl = `/api/skill-path?start=${encodeURIComponent(startSkill)}&end=${encodeURIComponent(endSkill)}`;
            }
            
            const pathResponse = await fetch(window.urlPrefix + pathUrl);
            pathData = await pathResponse.json(); // Store in global variable
            
            if (!pathData.path || pathData.path.length === 0) {
                throw new Error('No learning path found between these skills');
            }
            
            // Update path information
            updatePathInfo(pathData);
            
             // Create focused graph with only the path skills
             await createFocusedGraph(pathData);
             
             document.getElementById('loading').classList.add('loaded');
             
             // Fit to content with padding
             setTimeout(() => {
                 cy.fit(null, 50);
             }, 100);
            
        } catch (e) {
            console.error('Error loading learning path:', e);
            document.getElementById('loading').innerHTML = `
                <div style="color: #dc3545;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="margin-bottom: 10px;">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <div>Error: ${e.message}</div>
                    <button onclick="window.location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Try Again
                    </button>
                </div>
            `;
        }
    }
    
    function updatePathInfo(pathData) {
        const skills = pathData.path || [];
        const totalSkills = skills.length;
        
        // Update stats
        document.getElementById('total-skills').textContent = totalSkills;
        document.getElementById('estimated-time').textContent = `${Math.ceil(totalSkills * 2)} weeks`;
        document.getElementById('difficulty').textContent = totalSkills <= 3 ? 'Beginner' : totalSkills <= 6 ? 'Intermediate' : 'Advanced';
        
        // Update description
        const skillNames = skills.map(skill => skill.name || skill.id);
        document.getElementById('path-description').textContent = 
            `This learning path will take you through ${totalSkills} essential skills, from ${skillNames[0]} to ${skillNames[skillNames.length - 1]}. Each skill builds upon the previous one, creating a solid foundation for your learning journey.`;
        
        // Update skills display
        const skillsContainer = document.getElementById('path-skills');
        skillsContainer.innerHTML = '';
        
        skills.forEach((skill, index) => {
            const skillBadge = document.createElement('div');
            skillBadge.className = 'skill-badge';
            skillBadge.textContent = skill.name || skill.id;
            skillsContainer.appendChild(skillBadge);
            
            if (index < skills.length - 1) {
                const arrow = document.createElement('div');
                arrow.className = 'skill-arrow';
                arrow.innerHTML = '→';
                skillsContainer.appendChild(arrow);
            }
        });
    }
    
    async function createFocusedGraph(pathData) {
        const skills = pathData.path || [];
        
        // Create nodes and edges for only the path skills
        const nodes = skills.map(skill => ({
            data: {
                id: skill.id,
                name: skill.name || skill.id,
                description: skill.description || ''
            },
            classes: 'path-skill'
        }));
        
        const edges = [];
        for (let i = 0; i < skills.length - 1; i++) {
            edges.push({
                data: {
                    id: `${skills[i].id}-${skills[i + 1].id}`,
                    source: skills[i].id,
                    target: skills[i + 1].id
                },
                classes: 'path-edge'
            });
        }
        
        // Get style from existing stylesheet (same as skills_graph_flat.html)
        const styleText = await (await fetch('{{ static_url("/skills-graph.cycss") }}')).text();
        
         cy = cytoscape({
             container: document.getElementById('cy'),
             elements: { nodes, edges },
             style: styleText,
             layout: { name: 'cose' },
         });

         bind();
     }
     
     function bind() {
         // Add click handlers for skill details - show expanded learning nodes
        cy.on('tap', 'node', async function(evt) {
            const node = evt.target;
            const skillId = node.data('id');
            const skillName = node.data('name');
            
            console.log(`🎯 Clicked on skill: ${skillName}`);
            
            try {
                // Fetch learning graph for this skill (include IDs for precise updates)
                const rpId = getCurrentUserRoadmapPathId();
                const params = new URLSearchParams();
                if (rpId) params.set('user_roadmap_path_id', rpId);
                if (skillId) params.set('skill_id', skillId);
                const query = params.toString() ? `?${params.toString()}` : '';
                const response = await fetch(`${window.urlPrefix}/api/skill/${encodeURIComponent(skillName)}/learning-graph${query}`);
                 const data = await response.json();
                 
                 if (data.learning_nodes && data.learning_nodes.length > 0) {
                     // Show expanded learning nodes as connected graph
                     showExpandedLearningNodes(skillName, skillId, data.learning_nodes, data.edges);
                 } else {
                    // Fallback to chat widget
                    if (window.chatWidget && window.chatWidget.isOpen) {
                        window.chatWidget.setInputValue(`Tell me more about ${skillName}`);
                    } else {
                        window.chatWidget.openChat();
                        setTimeout(() => {
                            window.chatWidget.setInputValue(`Tell me more about ${skillName}`);
                        }, 300);
                    }
                }
            } catch (error) {
                console.error('Error fetching learning nodes:', error);
                // Fallback to chat widget
                if (window.chatWidget && window.chatWidget.isOpen) {
                    window.chatWidget.setInputValue(`Tell me more about ${skillName}`);
                } else {
                    window.chatWidget.openChat();
                    setTimeout(() => {
                        window.chatWidget.setInputValue(`Tell me more about ${skillName}`);
                    }, 300);
                }
            }
        });

         // Add hover effects for nodes (same as skills_graph_flat.html)
         cy.on('mouseover', 'node', function(evt) {
             const node = evt.target;
             node.style('background-color', '#e3f2fd');
             node.style('border-color', '#2196f3');
         });

         cy.on('mouseout', 'node', function(evt) {
             const node = evt.target;
             node.style('background-color', '');
             node.style('border-color', '');
         });
     }
    
     // Function to show expanded learning nodes as a connected graph
     async function showExpandedLearningNodes(skillName, skillId, learningNodes, edges) {
         console.log(`🎯 Showing expanded learning nodes for: ${skillName} (ID: ${skillId})`, learningNodes, edges);
         
         // Create or update the expanded view
         let expandedView = document.getElementById('expanded-learning-nodes');
         if (!expandedView) {
             expandedView = document.createElement('div');
             expandedView.id = 'expanded-learning-nodes';
             expandedView.className = 'expanded-learning-nodes';
             document.querySelector('.learning-path-content').appendChild(expandedView);
         }
         
         // Create HTML content with filters and horizontal list
         const listHTML = showLearningNodesList(learningNodes, skillId);
         const filterHTML = createFilterControls(learningNodes);
         expandedView.innerHTML = `
             <div class="expanded-header">
                 <h3>📚 Learning Nodes for ${skillName}</h3>
                 <button class="close-expanded" onclick="closeExpandedLearningNodes()">
                     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                         <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"/>
                     </svg>
                 </button>
             </div>
             ${filterHTML}
             <div class="filter-results" id="filter-results">
                 <span id="filter-results-text">Showing all learning nodes</span>
                 <span id="filter-results-count"></span>
             </div>
             <div class="no-results hidden" id="no-results">
                 <div>🔍 No learning nodes match your current filters</div>
                 <div style="margin-top: 10px; font-size: 12px;">Try adjusting your search or filter criteria</div>
             </div>
             <div class="learning-nodes-list-container" id="learning-nodes-list">
                 ${listHTML}
             </div>
         `;
         
         // Show the expanded view with animation
         expandedView.style.display = 'block';
         expandedView.style.opacity = '0';
         expandedView.style.transform = 'translateY(20px)';
         
         setTimeout(() => {
             expandedView.style.transition = 'all 0.3s ease';
             expandedView.style.opacity = '1';
             expandedView.style.transform = 'translateY(0)';
             
             // Restore completion states after the view is visible
             setTimeout(() => {
                 restoreCompletionStates();
             }, 200);
         }, 100);
         
         // Scroll to the expanded view
         expandedView.scrollIntoView({ behavior: 'smooth', block: 'start' });
     }
     
     // Function to initialize the learning nodes graph (SAVED FOR FUTURE USE)
     async function initializeLearningNodesGraph(learningNodes, edges) {
         try {
             // Create nodes for learning nodes
             const nodes = learningNodes.map((node, index) => ({
                 data: {
                     id: node.id,
                     name: node.name,
                     description: node.description || '',
                     depth: node.depth,
                     step: index + 1
                 },
                 classes: `learning-node depth-${node.depth}`
             }));
             
             // Create edges from the API data
             const graphEdges = edges.map(edge => ({
                 data: {
                     id: `${edge.source}-${edge.target}`,
                     source: edge.source,
                     target: edge.target
                 },
                 classes: 'learning-edge'
             }));
             
             // Get base styles
             const styleText = await (await fetch('{{ static_url("/skills-graph.cycss") }}')).text();
             
             // Add custom styles for learning nodes
             const customStyles = `
                 .learning-node {
                     background-color: #17a2b8;
                     border-color: #138496;
                     border-width: 2px;
                     label: data(name);
                     font-size: 12px;
                     text-valign: center;
                     text-halign: center;
                     width: 120px;
                     height: 60px;
                     shape: roundrectangle;
                 }
                 .learning-node.depth-0 {
                     background-color: #28a745;
                     border-color: #1e7e34;
                 }
                 .learning-node.depth-1 {
                     background-color: #ffc107;
                     border-color: #e0a800;
                     color: #212529;
                 }
                 .learning-node.depth-2 {
                     background-color: #dc3545;
                     border-color: #c82333;
                 }
                 .learning-edge {
                     line-color: #6c757d;
                     line-width: 2px;
                     target-arrow-color: #6c757d;
                     target-arrow-shape: triangle;
                 }
             `;
             
             // Initialize Cytoscape for learning nodes
             const learningCy = cytoscape({
                 container: document.getElementById('learning-nodes-cy'),
                 elements: { nodes, edges: graphEdges },
                 style: styleText + customStyles,
                 layout: { name: 'cose' },
             });
             
             // Add event handlers
             learningCy.on('tap', 'node', function(evt) {
                 const node = evt.target;
                 const nodeId = node.data('id');
                 const nodeName = node.data('name');
                 
                 console.log(`🎯 Clicked learning node: ${nodeName}`);
                 
                 if (window.chatWidget) {
                     const message = `I want to learn more about "${nodeName}". Can you provide detailed guidance on this learning node?`;
                     
                     if (!window.chatWidget.isOpen) {
                         window.chatWidget.openChat();
                         setTimeout(() => {
                             window.chatWidget.setInputValue(message);
                         }, 300);
                     } else {
                         window.chatWidget.setInputValue(message);
                     }
                 }
             });
             
             // Add hover effects
             learningCy.on('mouseover', 'node', function(evt) {
                 const node = evt.target;
                 node.style('background-color', '#e3f2fd');
                 node.style('border-color', '#2196f3');
             });

             learningCy.on('mouseout', 'node', function(evt) {
                 const node = evt.target;
                 // Reset to original color based on depth
                 const depth = node.data('depth');
                 const colors = {
                     0: '#28a745',
                     1: '#ffc107', 
                     2: '#dc3545'
                 };
                 const borderColors = {
                     0: '#1e7e34',
                     1: '#e0a800',
                     2: '#c82333'
                 };
                 node.style('background-color', colors[depth] || '#17a2b8');
                 node.style('border-color', borderColors[depth] || '#138496');
             });
             
             // Hide loading indicator
             document.getElementById('learning-nodes-loading').classList.add('loaded');
             
             // Fit to content
             setTimeout(() => {
                 learningCy.fit(null, 50);
             }, 100);
             
         } catch (error) {
             console.error('Error initializing learning nodes graph:', error);
             document.getElementById('learning-nodes-loading').innerHTML = `
                 <div style="color: #dc3545;">
                     <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="margin-bottom: 10px;">
                         <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                     </svg>
                     <div>Error loading learning nodes graph</div>
                 </div>
             `;
         }
     }

     // Function to create filter controls HTML
     function createFilterControls(learningNodes) {
         
         return `
             <div class="learning-nodes-filters">
                 <div class="filter-group">
                     <label class="filter-label">Search:</label>
                     <input type="text" class="filter-input" id="search-filter" placeholder="Search learning nodes..." onkeyup="applyFilters()">
                 </div>
                 
                 <div class="filter-group">
                     <label class="filter-label">Status:</label>
                     <select class="filter-select" id="status-filter" onchange="applyFilters()">
                         <option value="all">All</option>
                         <option value="completed">Completed</option>
                         <option value="pending">Pending</option>
                     </select>
                 </div>
                 
                 
                 <div class="filter-buttons">
                     <button class="filter-btn primary" onclick="applyFilters()">
                         <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                             <path d="M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H9.97L4.21,4.62C3.87,4.19 3.95,3.56 4.38,3.22C4.57,3.08 4.78,3 5,3V3H19V3C19.22,3 19.43,3.08 19.62,3.22C20.05,3.56 20.13,4.19 19.79,4.62L14.03,12H14Z"/>
                         </svg>
                         Filter
                     </button>
                     <button class="filter-btn secondary" onclick="resetFilters()">
                         <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                             <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                         </svg>
                         Reset
                     </button>
                     <button class="filter-btn danger" onclick="clearAllCompletions()">
                         <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                             <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                         </svg>
                         Clear All
                     </button>
                 </div>
             </div>
         `;
     }

     // Function to show learning nodes as horizontal list
     function showLearningNodesList(learningNodes, skillId) {
         console.log(`🎯 Showing learning nodes list:`, learningNodes);
         
         // Sort learning nodes by depth and name for better organization
         const sortedNodes = learningNodes.sort((a, b) => {
             if (a.depth !== b.depth) return a.depth - b.depth;
             return a.name.localeCompare(b.name);
         });
         
         // Create horizontal list HTML with checkboxes
         const listHTML = sortedNodes.map((node, index) => `
             <div class="learning-node-item" data-depth="${node.depth}" data-node-id="${node.id}" id="node-${node.id}" data-name="${node.name.toLowerCase()}" data-description="${(node.description || '').toLowerCase()}" data-skill-id="${skillId}">
                 <div class="completion-checkbox" onclick="toggleNodeCompletion('${node.id}')" id="checkbox-${node.id}"></div>
                 <div class="node-step">${index + 1}</div>
                 <div class="node-content">
                     <div class="node-name">${node.name}</div>
                     ${node.description ? `<div class="node-description">${node.description}</div>` : ''}
                 </div>
                 <div class="node-actions">
                     <button class="action-btn primary" onclick="showResources('${node.id}', '${node.name}')">
                         Resources
                     </button>
                 </div>
             </div>
         `).join('');
         
         return listHTML;
     }
     
     // Function to close expanded learning nodes
    function closeExpandedLearningNodes() {
        const expandedView = document.getElementById('expanded-learning-nodes');
        if (expandedView) {
            expandedView.style.transition = 'all 0.3s ease';
            expandedView.style.opacity = '0';
            expandedView.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                expandedView.style.display = 'none';
            }, 300);
        }
    }
    
     // Function to start learning a specific skill
     function startLearningSkill(skillName) {
         console.log(`🚀 Starting learning for skill: ${skillName}`);
         
         if (window.chatWidget) {
             const message = `🚀 I want to start learning "${skillName}". Can you guide me through this skill and its learning nodes?`;
             
             if (!window.chatWidget.isOpen) {
                 window.chatWidget.openChat();
                 setTimeout(() => {
                     window.chatWidget.setInputValue(message);
                 }, 300);
             } else {
                 window.chatWidget.setInputValue(message);
             }
         }
     }
     
     // Function to chat about a specific skill
     function chatAboutSkill(skillName) {
         console.log(`💬 Chatting about skill: ${skillName}`);
         
         if (window.chatWidget) {
             const message = `I have questions about "${skillName}" and its learning nodes. Can you help me understand this skill better?`;
             
             if (!window.chatWidget.isOpen) {
                 window.chatWidget.openChat();
                 setTimeout(() => {
                     window.chatWidget.setInputValue(message);
                 }, 300);
             } else {
                 window.chatWidget.setInputValue(message);
             }
         }
     }

     // Function to show resources for a specific learning node
     async function showResources(nodeId, nodeName) {
         console.log(`📚 Showing resources for node: ${nodeName}`);
         
         try {
             const response = await fetch(`${window.urlPrefix}/api/learning-node/${encodeURIComponent(nodeId)}/resources`);
             const data = await response.json();
             
             if (data.resources && data.resources.length > 0) {
                 showResourcesModal(nodeName, data.resources);
             } else {
                 if (window.chatWidget) {
                     const message = `I'm looking for resources about "${nodeName}". Can you help me find learning materials for this topic?`;
                     
                     if (!window.chatWidget.isOpen) {
                         window.chatWidget.openChat();
                         setTimeout(() => {
                             window.chatWidget.setInputValue(message);
                         }, 300);
                     } else {
                         window.chatWidget.setInputValue(message);
                     }
                 }
             }
         } catch (error) {
             console.error('Error fetching resources:', error);
             if (window.chatWidget) {
                 const message = `I'm looking for resources about "${nodeName}". Can you help me find learning materials for this topic?`;
                 
                 if (!window.chatWidget.isOpen) {
                     window.chatWidget.openChat();
                     setTimeout(() => {
                         window.chatWidget.setInputValue(message);
                     }, 300);
                 } else {
                     window.chatWidget.setInputValue(message);
                 }
             }
         }
     }

     // Function to show resources modal
     function showResourcesModal(nodeName, resources) {
         const modal = document.createElement('div');
         modal.className = 'resources-modal';
         modal.innerHTML = `
             <div class="resources-modal-content">
                 <div class="resources-modal-header">
                     <h3>📚 Resources for ${nodeName}</h3>
                     <button class="close-resources" onclick="closeResourcesModal()">
                         <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                             <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"/>
                         </svg>
                     </button>
                 </div>
                 <div class="resources-list">
                     ${resources.map(resource => `
                         <div class="resource-item">
                             <div class="resource-info">
                                 <div class="resource-title">${resource.title}</div>
                                 <div class="resource-type">${resource.type || 'Resource'}</div>
                             </div>
                             <div class="resource-actions">
                                 <a href="${resource.url}" target="_blank" class="resource-link">
                                     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                         <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
                                     </svg>
                                     Open
                                 </a>
                             </div>
                         </div>
                     `).join('')}
                 </div>
             </div>
         `;
         
         document.body.appendChild(modal);
         
         // Show modal with animation
         setTimeout(() => {
             modal.style.opacity = '1';
             modal.style.transform = 'scale(1)';
         }, 100);
     }

     // Function to toggle node completion
     async function toggleNodeCompletion(nodeId) {
         const checkbox = document.getElementById(`checkbox-${nodeId}`);
         const nodeItem = document.getElementById(`node-${nodeId}`);
         
         if (!checkbox || !nodeItem) return;
         
         const isCompleted = checkbox.classList.contains('checked');
         
         if (isCompleted) {
             // Mark as incomplete
             checkbox.classList.remove('checked');
             nodeItem.classList.remove('completed');
             await saveNodeCompletion(nodeId, false);
         } else {
             // Mark as complete
             checkbox.classList.add('checked');
             nodeItem.classList.add('completed');
             await saveNodeCompletion(nodeId, true);
         }
         
         // Update completion progress and apply filters
         updateCompletionProgress();
         applyFilters();
     }

     // Function to save node completion state to database and localStorage
     async function saveNodeCompletion(nodeId, isCompleted) {
         // Save to localStorage for immediate UI feedback
         const completedNodes = getCompletedNodes();
         
         if (isCompleted) {
             if (!completedNodes.includes(nodeId)) {
                 completedNodes.push(nodeId);
             }
         } else {
             const index = completedNodes.indexOf(nodeId);
             if (index > -1) {
                 completedNodes.splice(index, 1);
             }
         }
         
         localStorage.setItem('completedLearningNodes', JSON.stringify(completedNodes));
         
         // Save to database if we have the required data
         try {
             let userRoadmapPathId = getCurrentUserRoadmapPathId();
             
            // If no roadmap path ID exists, try to get or create one
            if (!userRoadmapPathId) {
                // If we have a roadmap path ID from URL, use that
                if (roadmapPathId) {
                    console.log('Using roadmap path ID from URL:', roadmapPathId);
                    userRoadmapPathId = roadmapPathId;
                    setCurrentUserRoadmapPathId(roadmapPathId);
                } else {
                    console.log('No user roadmap path ID available, skipping database save');
                    return;
                }
            }
             
             const nodeItem = document.getElementById(`node-${nodeId}`);
             const skillId = nodeItem?.dataset.skillId || '';
             
             if (isCompleted) {
                 // Mark as completed in database
                 const response = await fetch('{{ url_for_prefix("/api/learning-node/complete") }}', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         learning_node_id: nodeId,
                         skill_id: skillId,
                         user_roadmap_path_id: userRoadmapPathId,
                         completed_at: new Date().toISOString()
                     })
                 });
                 
                 if (response.ok) {
                     const result = await response.json();
                     console.log('✅ Learning node completed in database:', result);
                 } else {
                     console.warn('⚠️ Failed to save completion to database');
                 }
             } else {
                 // Mark as incomplete in database
                 const response = await fetch('{{ url_for_prefix("/api/learning-node/incomplete") }}', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         learning_node_id: nodeId,
                         user_roadmap_path_id: userRoadmapPathId
                     })
                 });
                 
                 if (response.ok) {
                     const result = await response.json();
                     console.log('✅ Learning node marked incomplete in database:', result);
                 } else {
                     console.warn('⚠️ Failed to remove completion from database');
                 }
             }
         } catch (error) {
             console.error('❌ Error saving node completion to database:', error);
         }
     }

     // Function to get completed nodes from localStorage
     function getCompletedNodes() {
         const saved = localStorage.getItem('completedLearningNodes');
         return saved ? JSON.parse(saved) : [];
     }
     
     // Function to get current user roadmap path ID
     function getCurrentUserRoadmapPathId() {
         // This should be set when the learning track is saved
         return window.currentUserRoadmapPathId || null;
     }
     
     // Function to set current user roadmap path ID
     function setCurrentUserRoadmapPathId(pathId) {
         window.currentUserRoadmapPathId = pathId;
     }
     
     // Function to get or create user roadmap path
     async function getOrCreateUserRoadmapPath() {
         try {
             // First, try to get existing user progress
             const response = await fetch('{{ url_for_prefix("/api/user/progress") }}');
             if (response.ok) {
                 const data = await response.json();
                 if (data.user_paths && data.user_paths.length > 0) {
                     // Return the first user roadmap path ID
                     return data.user_paths[0].id;
                 }
             }
             
             // If no existing progress, create a new learning track
             const startSkill = urlParams.get('start') || 'data analyst';
             const endSkill = urlParams.get('end') || 'ai agents';
             
             // Get current path data
             let currentPathData = pathData;
             if (!currentPathData || !currentPathData.path) {
                 let pathUrl;
                 if (roadmapPathId) {
                     pathUrl = `/api/skill-path?user_roadmap_path_id=${encodeURIComponent(roadmapPathId)}`;
                 } else {
                     pathUrl = `/api/skill-path?start=${encodeURIComponent(startSkill)}&end=${encodeURIComponent(endSkill)}`;
                 }
                 const pathResponse = await fetch(window.urlPrefix + pathUrl);
                 currentPathData = await pathResponse.json();
             }
             
             if (currentPathData && currentPathData.path) {
                 const trackData = {
                     start_skill: startSkill,
                     target_skill: endSkill,
                     skill_path: currentPathData.path
                 };
                 
                 const saveResponse = await fetch('{{ url_for_prefix("/api/route-planning/start-learning") }}', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify(trackData)
                 });
                 
                 if (saveResponse.ok) {
                     const saveResult = await saveResponse.json();
                     if (saveResult.data && saveResult.data.user_roadmap_path_id) {
                         return saveResult.data.user_roadmap_path_id;
                     }
                 }
             }
             
             return null;
         } catch (error) {
             console.error('Error getting or creating user roadmap path:', error);
             return null;
         }
     }

     // Function to restore completion states
     function restoreCompletionStates() {
         const completedNodes = getCompletedNodes();
         
         completedNodes.forEach(nodeId => {
             const checkbox = document.getElementById(`checkbox-${nodeId}`);
             const nodeItem = document.getElementById(`node-${nodeId}`);
             
             if (checkbox && nodeItem) {
                 checkbox.classList.add('checked');
                 nodeItem.classList.add('completed');
             }
         });
         
         updateCompletionProgress();
         applyFilters();
     }

     // Function to update completion progress display
     function updateCompletionProgress() {
         // Progress tracking is now handled in the filter results bar only
         // No more floating progress toast notification
     }

     // Filter functionality functions
     function applyFilters() {
         const searchTerm = document.getElementById('search-filter')?.value.toLowerCase() || '';
         const statusFilter = document.getElementById('status-filter')?.value || 'all';
         
         const allNodes = document.querySelectorAll('.learning-node-item');
         let visibleCount = 0;
         let completedCount = 0;
         
         allNodes.forEach(node => {
             const nodeName = node.dataset.name || '';
             const nodeDescription = node.dataset.description || '';
             const nodeDepth = node.dataset.depth;
             const isCompleted = node.classList.contains('completed');
             
             let shouldShow = true;
             
             // Search filter
             if (searchTerm && !nodeName.includes(searchTerm) && !nodeDescription.includes(searchTerm)) {
                 shouldShow = false;
             }
             
             // Status filter
             if (statusFilter === 'completed' && !isCompleted) {
                 shouldShow = false;
             } else if (statusFilter === 'pending' && isCompleted) {
                 shouldShow = false;
             }
             
             if (shouldShow) {
                 node.style.display = 'flex';
                 visibleCount++;
                 if (isCompleted) completedCount++;
             } else {
                 node.style.display = 'none';
             }
         });
         
         // Update filter results
         updateFilterResults(visibleCount, completedCount, allNodes.length);
         
         // Show/hide no results message
         const noResults = document.getElementById('no-results');
         if (visibleCount === 0) {
             noResults?.classList.remove('hidden');
         } else {
             noResults?.classList.add('hidden');
         }
     }

     function updateFilterResults(visibleCount, completedCount, totalCount) {
         const resultsText = document.getElementById('filter-results-text');
         const resultsCount = document.getElementById('filter-results-count');
         
         if (resultsText && resultsCount) {
             if (visibleCount === totalCount) {
                 resultsText.textContent = 'Showing all learning nodes';
             } else {
                 resultsText.textContent = `Showing ${visibleCount} of ${totalCount} learning nodes`;
             }
             
             resultsCount.textContent = `${completedCount} completed`;
         }
     }

     function resetFilters() {
         const searchFilter = document.getElementById('search-filter');
         const statusFilter = document.getElementById('status-filter');
         
         if (searchFilter) searchFilter.value = '';
         if (statusFilter) statusFilter.value = 'all';
         
         applyFilters();
     }

     function clearAllCompletions() {
         if (confirm('Are you sure you want to clear all completion states? This action cannot be undone.')) {
             const allNodes = document.querySelectorAll('.learning-node-item');
             
             allNodes.forEach(node => {
                 const nodeId = node.dataset.nodeId;
                 if (nodeId) {
                     const checkbox = document.getElementById(`checkbox-${nodeId}`);
                     if (checkbox && checkbox.classList.contains('checked')) {
                         checkbox.classList.remove('checked');
                         node.classList.remove('completed');
                         saveNodeCompletion(nodeId, false);
                     }
                 }
             });
             
             updateCompletionProgress();
             applyFilters();
             
             // Show confirmation message
             const message = document.createElement('div');
             message.style.cssText = `
                 position: fixed;
                 top: 50%;
                 left: 50%;
                 transform: translate(-50%, -50%);
                 background: #28a745;
                 color: white;
                 padding: 15px 25px;
                 border-radius: 8px;
                 box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                 z-index: 10000;
                 font-weight: 600;
             `;
             message.textContent = 'All completion states cleared!';
             document.body.appendChild(message);
             
             setTimeout(() => {
                 message.remove();
             }, 2000);
         }
     }

     // Function to close resources modal
     function closeResourcesModal() {
         const modal = document.querySelector('.resources-modal');
         if (modal) {
             modal.style.opacity = '0';
             modal.style.transform = 'scale(0.9)';
             setTimeout(() => {
                 modal.remove();
             }, 300);
         }
     }
    
     // Make functions globally available
     window.closeExpandedLearningNodes = closeExpandedLearningNodes;
     window.startLearningSkill = startLearningSkill;
     window.chatAboutSkill = chatAboutSkill;
     window.showResources = showResources;
     window.closeResourcesModal = closeResourcesModal;
     window.toggleNodeCompletion = toggleNodeCompletion;
     window.applyFilters = applyFilters;
     window.resetFilters = resetFilters;
     window.clearAllCompletions = clearAllCompletions;
    
    // Bind action buttons
    document.getElementById('begin-learning-action').addEventListener('click', async function() {
        try {
            const startSkill = urlParams.get('start');
            
            // Check if we have a roadmap path ID (from chat navigation)
            const currentRoadmapPathId = getCurrentUserRoadmapPathId();
            if (!currentRoadmapPathId) {
                console.log('No roadmap path ID available');
                // const newRoadmapPathId = await getOrCreateUserRoadmapPath();
                // if (newRoadmapPathId) {
                //     setCurrentUserRoadmapPathId(newRoadmapPathId);
                //     console.log('📊 User roadmap path ID created/retrieved:', newRoadmapPathId);
                // }
            }
            
            // Fetch learning graph for the first skill
            const response = await fetch(`${window.urlPrefix}/api/skill/${encodeURIComponent(startSkill)}/learning-graph`);
            const data = await response.json();
            
            if (data.learning_nodes && data.learning_nodes.length > 0) {
                // Show expanded learning nodes for the first skill
                // We need to get the skill ID for the start skill
                const skillId = startSkill; // For now, using the skill name as ID
                showExpandedLearningNodes(startSkill, skillId, data.learning_nodes, data.edges);
                
                // Scroll to the expanded view
                setTimeout(() => {
                    const expandedView = document.getElementById('expanded-learning-nodes');
                    if (expandedView) {
                        expandedView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 500);
            } else {
                // Fallback to chat
                if (window.chatWidget) {
                    const message = `🚀 Let's begin your learning journey with ${startSkill}! I'm here to guide you through each step.`;
                    
                    if (!window.chatWidget.isOpen) {
                        window.chatWidget.openChat();
                        setTimeout(() => {
                            window.chatWidget.addMessage(message, 'ai');
                        }, 300);
                    } else {
                        window.chatWidget.addMessage(message, 'ai');
                    }
                }
            }
        } catch (error) {
            console.error('Error opening first skill learning nodes:', error);
            // Fallback to chat
            if (window.chatWidget) {
                const startSkill = urlParams.get('start') || 'data analyst';
                const message = `🚀 Let's begin your learning journey with ${startSkill}! I'm here to guide you through each step.`;
                
                if (!window.chatWidget.isOpen) {
                    window.chatWidget.openChat();
                    setTimeout(() => {
                        window.chatWidget.addMessage(message, 'ai');
                    }, 300);
                } else {
                    window.chatWidget.addMessage(message, 'ai');
                }
            }
        }
    });

    document.getElementById('ask-questions-action').addEventListener('click', function() {
        if (window.chatWidget) {
            if (!window.chatWidget.isOpen) {
                window.chatWidget.openChat();
            }
            
            const startSkill = urlParams.get('start') || 'data analyst';
            const endSkill = urlParams.get('end') || 'ai agents';
            
            setTimeout(() => {
                window.chatWidget.setInputValue(`I have questions about the learning path from ${startSkill} to ${endSkill}`);
            }, 300);
        }
    });
    
    // Function to open notes modal
    window.openNotesPage = function() {
        // Reset form and show modal
        document.getElementById('note-form').reset();
        document.getElementById('modal-title').textContent = 'Create New Note';
        document.getElementById('save-note-btn').textContent = 'Save Note';
        document.getElementById('save-note-btn').onclick = (event) => {
            event.preventDefault();
            handleSaveNote();
        };
        document.getElementById('note-modal').style.display = 'block';
        
        // Focus on title input
        setTimeout(() => {
            document.getElementById('note-title-input').focus();
        }, 100);
    };

    // Close modal
    function closeModal() {
        document.getElementById('note-modal').style.display = 'none';
        document.getElementById('note-form').reset();
    }

    // Save note function
    async function handleSaveNote() {
        const title = document.getElementById('note-title-input').value.trim();
        const content = document.getElementById('note-content-input').value.trim();
        const tags = document.getElementById('note-tags-input').value.trim();
        const isFavorite = document.getElementById('note-favorite-input').checked;

        if (!title || !content) {
            alert('Please fill in both title and content');
            return;
        }

        try {
            const tagsArray = tags ? tags.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : [];
            
            const noteData = {
                title: title,
                content: content,
                tags: tagsArray,
                is_favorite: isFavorite
            };

            const response = await fetch('{{ url_for_prefix("/api/user/notes") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(noteData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save note');
            }

            const result = await response.json();
            if (result.success) {
                alert('Note saved successfully!');
                closeModal();
            } else {
                throw new Error(result.message || 'Failed to save note');
            }
        } catch (error) {
            console.error('Error saving note:', error);
            alert('Error saving note: ' + error.message);
        }
    }

    // Setup modal event listeners
    function setupModalEventListeners() {
        // Form submission
        document.getElementById('note-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleSaveNote();
        });

        // Close modal when clicking outside
        document.getElementById('note-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('note-modal')) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    }
    
    // Initialize modal event listeners
    setupModalEventListeners();
    
    init();
});
</script>
{% endblock %}
