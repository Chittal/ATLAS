{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/tippy.js@2.0.9/dist/tippy.css" />
<style>
    #cy {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    #loading {
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        text-align: center;
        margin-top: -0.5em;
        font-size: 2em;
        color: #6c757d;
        z-index: 1000;
    }

    #loading.loaded {
        display: none;
    }

    .controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls button {
        margin: 5px;
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .controls button:hover {
        background-color: #0056b3;
    }

    .controls button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .skill-info {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 300px;
        display: none;
    }

    .path-info {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 300px;
        display: none;
    }

    /* Tutorial Overlay Styles */
    .tutorial-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
        pointer-events: auto;
    }

    .tutorial-content {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.4s ease-out;
        pointer-events: auto;
        position: relative;
        z-index: 10001;
    }

    .tutorial-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 24px 0 24px;
    }

    .tutorial-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        animation: pulse 2s infinite;
    }

    .tutorial-close {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .tutorial-close:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .tutorial-body {
        padding: 24px;
    }

    .tutorial-title {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 16px;
        text-align: center;
    }

    .tutorial-description {
        font-size: 16px;
        color: #6b7280;
        text-align: center;
        margin-bottom: 32px;
        line-height: 1.6;
    }

    .tutorial-steps {
        margin-bottom: 32px;
    }

    .tutorial-step {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 24px;
        animation: slideInLeft 0.6s ease-out;
    }

    .tutorial-step:nth-child(2) {
        animation-delay: 0.1s;
    }

    .tutorial-step:nth-child(3) {
        animation-delay: 0.2s;
    }

    .step-number {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .step-content h4 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .step-content p {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
    }

    .tutorial-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .tutorial-primary-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border: none;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
        pointer-events: auto;
        position: relative;
        z-index: 10001;
    }

    .tutorial-primary-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.6);
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    }

    .tutorial-secondary-btn {
        background: none;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        pointer-events: auto;
        position: relative;
        z-index: 10001;
    }

    .tutorial-secondary-btn:hover {
        background: #f8fafc;
        color: #1e40af;
        border-color: #3b82f6;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Hide tutorial when dismissed */
    .tutorial-overlay.hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* Floating hint for chat */
    .chat-hint {
        position: fixed;
        bottom: 100px;
        right: 20px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.4);
        font-size: 14px;
        font-weight: 500;
        z-index: 1000;
        animation: slideInRight 0.5s ease-out;
        cursor: pointer;
        transition: all 0.2s ease;
        max-width: 200px;
        pointer-events: auto;
    }

    .chat-hint:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px 0 rgba(59, 130, 246, 0.6);
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    }

    .chat-hint.hidden {
        display: none;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>
{% endblock %}

{% block body %}
<!-- Tutorial Overlay -->
<div id="tutorial-overlay" class="tutorial-overlay">
    <div class="tutorial-content">
        <div class="tutorial-header">
            <div class="tutorial-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z" fill="currentColor"/>
            </svg>
        </div>
            <button id="tutorial-close" class="tutorial-close" title="Skip Tutorial">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
        
        <div class="tutorial-body">
            <h2 class="tutorial-title">Welcome to Your Learning Journey! ðŸš€</h2>
            <p class="tutorial-description">
                I'm your AI Learning Assistant, and I'm here to help you create a personalized learning path based on your goals and current knowledge.
            </p>
            
            <div class="tutorial-steps">
                <div class="tutorial-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Tell me about yourself</h4>
                        <p>Share what you already know and what you want to learn</p>
                    </div>
                </div>
                
                <div class="tutorial-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Get your personalized path</h4>
                        <p>I'll create a custom learning roadmap just for you</p>
                    </div>
                </div>
                
                <div class="tutorial-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Start learning</h4>
                        <p>Follow your path and track your progress</p>
                    </div>
                </div>
            </div>
            
            <div class="tutorial-actions">
                <button id="start-tutorial-btn" class="tutorial-primary-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="currentColor"/>
                        <path d="M7 9H17V11H7V9ZM7 12H15V14H7V12Z" fill="currentColor"/>
                    </svg>
                    Start Learning Now
                </button>
                <button id="skip-tutorial-btn" class="tutorial-secondary-btn">
                    I'll explore on my own
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Hint (shown after tutorial is dismissed) -->
<div id="chat-hint" class="chat-hint hidden">
    <div style="display: flex; align-items: center; gap: 8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="currentColor"/>
            <path d="M7 9H17V11H7V9ZM7 12H15V14H7V12Z" fill="currentColor"/>
        </svg>
        <span>Click here to start learning!</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="controls">
                <button id="clear">Clear Selection</button>
                <button id="reset-view">Reset View</button>
                <button id="layout-cose">Auto Layout</button>
                <button id="toggle-labels">Toggle Labels</button>
            </div>
            
            <div id="cy"></div>
            <div id="loading">
                <span class="spinner-border" role="status"></span>
                Loading skills graph...
            </div>
            
            <div class="skill-info" id="skill-info">
                <h6 id="skill-name"></h6>
                <p id="skill-description"></p>
                <small id="skill-category"></small>
            </div>
            
            <div class="path-info" id="path-info">
                <h6>Learning Path</h6>
                <p id="path-details"></p>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<!-- Load Cytoscape.js and dependencies -->
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/tippy.js@2.0.9/dist/tippy.all.js"></script>
<script src="https://unpkg.com/cytoscape-popper@1.0.2/cytoscape-popper.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let cy;
    let startNode = null;
    let endNode = null;
    let labelsVisible = true;

    // Initialize Cytoscape
    async function initCytoscape() {
        try {
            console.log('Starting Cytoscape initialization...');
            
            // Load data from API
            console.log('Fetching data from API...');
            const response = await fetch('{{ url_for_prefix("/api/roadmap-flat") }}');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Data loaded:', data);
            console.log('Nodes count:', data.elements?.nodes?.length || 0);
            console.log('Edges count:', data.elements?.edges?.length || 0);
            
            // Load styles
            console.log('Loading styles...');
            const styleResponse = await fetch('{{ static_url("/skills-graph.cycss") }}');
            if (!styleResponse.ok) {
                throw new Error(`Style file not found! status: ${styleResponse.status}`);
            }
            const style = await styleResponse.text();
            console.log('Styles loaded');
            
            // Hide loading
            document.getElementById('loading').classList.add('loaded');
            
            // Initialize Cytoscape
            console.log('Initializing Cytoscape...');
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: data.elements,
                style: style,
                layout: { name: 'cose' },
                selectionType: 'single',
                boxSelectionEnabled: false,
                autoungrabify: false,
                autolock: false
            });
            
            // Avoid using cytoscape-popper in the browser to prevent errors
            
            // Bind events
            bindEvents();
            
            console.log('Cytoscape initialized successfully!');
            console.log('Graph elements:', cy.elements().length);
            
        } catch (error) {
            console.error('Error initializing Cytoscape:', error);
            document.getElementById('loading').innerHTML = 'Error loading skills graph: ' + error.message;
        }
    }

    function bindEvents() {
        // Node click events
        cy.on('tap', 'node', function(evt) {
            const node = evt.target;
            showSkillInfo(node);
            
            if (!startNode) {
                selectStart(node);
            } else if (!endNode && node.id() !== startNode.id()) {
                selectEnd(node);
            }
        });

        // Background click
        cy.on('tap', function(evt) {
            if (evt.target === cy) {
                hideSkillInfo();
            }
        });

        // Control buttons
        document.getElementById('clear').addEventListener('click', clearSelection);
        document.getElementById('reset-view').addEventListener('click', resetView);
        document.getElementById('layout-cose').addEventListener('click', applyLayout);
        document.getElementById('toggle-labels').addEventListener('click', toggleLabels);
    }

    function selectStart(node) {
        clearSelection();
        startNode = node;
        node.addClass('start');
        document.body.classList.add('has-start');
    }

    function selectEnd(node) {
        endNode = node;
        node.addClass('end');
        document.body.classList.add('has-end');
        
        // Calculate and show path
        calculatePath(startNode, endNode);
    }

    async function calculatePath(start, end) {
        try {
            const startName = start.data('name');
            const endName = end.data('name');
            const response = await fetch(`/api/skill-path?start=${encodeURIComponent(startName)}&end=${encodeURIComponent(endName)}`);
            const pathData = await response.json();

            if (pathData.path && pathData.path.length > 0) {
                // Convert objects to ids if needed
                const pathIds = pathData.path.map(item => typeof item === 'object' ? item.id : item);
                highlightPath(pathIds);
                showPathInfo({ path: pathIds });
            } else {
                showPathInfo({ path: [], message: 'No direct path found' });
            }
        } catch (error) {
            console.error('Error calculating path:', error);
            showPathInfo({ path: [], message: 'Error calculating path' });
        }
    }

    function highlightPath(path) {
        cy.elements().removeClass('path not-path');
        
        // Highlight path nodes and edges
        path.forEach((nodeId, index) => {
            const node = cy.getElementById(nodeId);
            node.addClass('path');
            
            if (index < path.length - 1) {
                const edge = cy.getElementById(`${nodeId}-${path[index + 1]}`);
                if (edge.length > 0) {
                    edge.addClass('path');
                }
            }
        });
        
        // Dim non-path elements
        cy.elements().not('.path').addClass('not-path');
    }

    function showSkillInfo(node) {
        const data = node.data();
        document.getElementById('skill-name').textContent = data.name;
        document.getElementById('skill-description').textContent = data.description || 'No description available';
        document.getElementById('skill-category').textContent = `Category: ${data.category} | Difficulty: ${data.difficulty}`;
        document.getElementById('skill-info').style.display = 'block';
    }

    function hideSkillInfo() {
        document.getElementById('skill-info').style.display = 'none';
    }

    function showPathInfo(pathData) {
        const pathInfo = document.getElementById('path-info');
        const pathDetails = document.getElementById('path-details');
        
        if (pathData.path && pathData.path.length > 0) {
            pathDetails.textContent = `Path: ${pathData.path.join(' â†’ ')}`;
        } else {
            pathDetails.textContent = pathData.message || 'No path found';
        }
        
        pathInfo.style.display = 'block';
    }

    function clearSelection() {
        startNode = null;
        endNode = null;
        cy.elements().removeClass('start end path not-path');
        document.body.classList.remove('has-start', 'has-end');
        document.getElementById('path-info').style.display = 'none';
    }

    function resetView() {
        cy.fit();
    }

    function applyLayout() {
        cy.layout({ name: 'cose' }).run();
    }

    function toggleLabels() {
        labelsVisible = !labelsVisible;
        cy.style().selector('node').style('label', labelsVisible ? 'data(name)' : '').update();
    }

    // Initialize
    initCytoscape();
});

// Tutorial functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tutorial script loaded');
    
    const tutorialOverlay = document.getElementById('tutorial-overlay');
    const tutorialClose = document.getElementById('tutorial-close');
    const skipTutorialBtn = document.getElementById('skip-tutorial-btn');
    const startTutorialBtn = document.getElementById('start-tutorial-btn');
    
    console.log('Tutorial elements found:', {
        overlay: tutorialOverlay,
        close: tutorialClose,
        skip: skipTutorialBtn,
        start: startTutorialBtn
    });
    
    // Check if user has seen tutorial before
    const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
    console.log('Has seen tutorial:', hasSeenTutorial);
    
    if (!hasSeenTutorial) {
        // Show tutorial overlay
        if (tutorialOverlay) {
            tutorialOverlay.style.display = 'flex';
            console.log('Showing tutorial overlay');
        }
    } else {
        if (tutorialOverlay) {
            tutorialOverlay.classList.add('hidden');
        }
        
        // Show chat hint for returning users
        setTimeout(() => {
            const chatHint = document.getElementById('chat-hint');
            if (chatHint) {
                chatHint.classList.remove('hidden');
                
                // Auto-hide hint after 8 seconds for returning users
                setTimeout(() => {
                    chatHint.classList.add('hidden');
                }, 8000);
            }
        }, 2000);
    }
    
    // Close tutorial handlers
    function closeTutorial() {
        console.log('closeTutorial function called');
        if (tutorialOverlay) {
            tutorialOverlay.classList.add('hidden');
            tutorialOverlay.style.display = 'none';
            console.log('Tutorial overlay hidden');
        }
        localStorage.setItem('hasSeenTutorial', 'true');
        
        // Show chat hint after a short delay
        setTimeout(() => {
            const chatHint = document.getElementById('chat-hint');
            if (chatHint) {
                chatHint.classList.remove('hidden');
                
                // Auto-hide hint after 10 seconds
                setTimeout(() => {
                    chatHint.classList.add('hidden');
                }, 10000);
            }
        }, 1000);
    }
    
    // Add event listeners with debugging
    if (tutorialClose) {
        tutorialClose.addEventListener('click', function(e) {
            console.log('Close button clicked');
            e.preventDefault();
            closeTutorial();
        });
                    } else {
        console.error('Tutorial close button not found');
    }
    
    if (skipTutorialBtn) {
        skipTutorialBtn.addEventListener('click', function(e) {
            console.log('Skip button clicked');
            e.preventDefault();
            closeTutorial();
        });
    } else {
        console.error('Skip tutorial button not found');
    }
    
    // Start tutorial - open chat and send initial message
    if (startTutorialBtn) {
        startTutorialBtn.addEventListener('click', function(e) {
            console.log('Start tutorial button clicked');
            e.preventDefault();
            closeTutorial();
            
            // Open chat widget
            const chatToggle = document.getElementById('chat-toggle');
            const chatWindow = document.getElementById('chat-window');
            
            if (chatToggle && chatWindow) {
                // Trigger chat open
                chatToggle.click();
                
                // Wait a bit for chat to open, then send initial message
                setTimeout(() => {
                    const chatInput = document.getElementById('chat-input');
                    const chatSend = document.getElementById('chat-send');
                    
                    if (chatInput && chatSend) {
                        // Focus on chat input
                        chatInput.focus();
                        
                        // Add a placeholder message to guide the user
                        chatInput.placeholder = "Tell me what you know and what you want to learn...";
                        
                        // Add a subtle animation to draw attention
                        chatInput.style.borderColor = '#3b82f6';
                        chatInput.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
                        
                        setTimeout(() => {
                            chatInput.style.borderColor = '';
                            chatInput.style.boxShadow = '';
                        }, 3000);
                    }
                }, 500);
            }
        });
    } else {
        console.error('Start tutorial button not found');
    }
    
    // Show tutorial again if user clicks on a specific element (optional)
    // You can add this to a help button or similar
    window.showTutorial = function() {
        if (tutorialOverlay) {
            tutorialOverlay.classList.remove('hidden');
            tutorialOverlay.style.display = 'flex';
        }
    };
    
    // Force close tutorial
    window.forceCloseTutorial = function() {
        if (tutorialOverlay) {
            tutorialOverlay.style.display = 'none';
            tutorialOverlay.classList.add('hidden');
            console.log('Tutorial force closed');
        }
    };
    
    // Debug function to test button clicks
    window.testTutorialButtons = function() {
        console.log('Testing tutorial buttons...');
        const primaryBtn = document.getElementById('start-tutorial-btn');
        const secondaryBtn = document.getElementById('skip-tutorial-btn');
        const closeBtn = document.getElementById('tutorial-close');
        
        console.log('Primary button:', primaryBtn);
        console.log('Secondary button:', secondaryBtn);
        console.log('Close button:', closeBtn);
        
        if (primaryBtn) {
            console.log('Primary button clickable:', primaryBtn.style.pointerEvents);
        }
    };
    
    // Force show tutorial for testing
    window.forceShowTutorial = function() {
        localStorage.removeItem('hasSeenTutorial');
        location.reload();
    };
    
    // Test button clicks manually
    window.testButtonClicks = function() {
        console.log('Testing manual button clicks...');
        
        const startBtn = document.getElementById('start-tutorial-btn');
        const skipBtn = document.getElementById('skip-tutorial-btn');
        const closeBtn = document.getElementById('tutorial-close');
        
        if (startBtn) {
            console.log('Simulating start button click');
            startBtn.click();
        }
        
        if (skipBtn) {
            console.log('Simulating skip button click');
            skipBtn.click();
        }
        
        if (closeBtn) {
            console.log('Simulating close button click');
            closeBtn.click();
        }
    };
    
    // Simple close tutorial function
    window.closeTutorialNow = function() {
        const overlay = document.getElementById('tutorial-overlay');
        if (overlay) {
            overlay.style.display = 'none';
            overlay.classList.add('hidden');
            console.log('Tutorial closed manually');
        }
    };
    
    // Chat hint click handler
    const chatHint = document.getElementById('chat-hint');
    if (chatHint) {
        chatHint.addEventListener('click', function() {
            const chatToggle = document.getElementById('chat-toggle');
            if (chatToggle) {
                chatToggle.click();
                chatHint.classList.add('hidden');
            }
        });
    }
});
</script>
{% endblock %}
{% endblock %}
