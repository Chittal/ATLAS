<div class="notes-container">
    <div class="notes-header">
        <div>
            <h2 class="notes-title">My Notes</h2>
            <p class="notes-subtitle">Keep track of your learning progress and insights</p>
        </div>
        <button class="btn btn-primary" onclick="createNewNote()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            New Note
        </button>
    </div>

    <!-- Search and Filter Controls -->
    <div class="notes-controls">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search notes..." class="search-input">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="search-icon">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
        </div>
        <div class="filter-controls">
            <select id="tag-filter" class="filter-select">
                <option value="">All Tags</option>
            </select>
            <select id="favorite-filter" class="filter-select">
                <option value="">All Notes</option>
                <option value="true">Favorites Only</option>
            </select>
        </div>
    </div>

    <div class="notes-grid" id="notes-grid">
        <!-- Notes will be loaded dynamically -->
    </div>
</div>

<!-- Note Creation/Edit Modal -->
<div id="note-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Create New Note</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="note-form" class="note-form">
            <div class="form-group">
                <label for="note-title-input">Title</label>
                <input type="text" id="note-title-input" class="form-input" placeholder="Enter note title..." required>
            </div>
            <div class="form-group">
                <label for="note-content-input">Content</label>
                <textarea id="note-content-input" class="form-textarea" placeholder="Enter your note content..." rows="6" required></textarea>
            </div>
            <div class="form-group">
                <label for="note-tags-input">Tags</label>
                <input type="text" id="note-tags-input" class="form-input" placeholder="Enter tags separated by commas (e.g., Python, Programming, Learning)">
                <small class="form-help">Separate multiple tags with commas</small>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="note-favorite-input">
                    <span class="checkmark"></span>
                    Mark as favorite
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="save-note-btn">Save Note</button>
            </div>
        </form>
    </div>
</div>

<style>
    .notes-container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
    }

    .notes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .notes-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: hsl(var(--foreground));
        margin-bottom: 0.5rem;
    }

    .notes-subtitle {
        font-size: 1.125rem;
        color: hsl(var(--muted-foreground));
    }

    .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        width: 100%;
        align-items: start;
    }

    .note-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
        box-sizing: border-box;
        position: relative;
        background: linear-gradient(135deg, hsl(var(--card)) 0%, hsl(var(--card) / 0.95) 100%);
    }

    .note-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.15);
        border-color: hsl(var(--primary) / 0.2);
    }

    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .note-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: hsl(var(--foreground));
        line-height: 1.4;
        margin: 0;
        flex: 1;
        margin-right: 1rem;
    }

    .note-header-right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .note-date {
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
        white-space: nowrap;
        margin-top: 0.125rem;
    }

    .note-preview {
        color: hsl(var(--muted-foreground));
        line-height: 1.6;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
        flex: 1;
    }

    .note-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .note-tag {
        background: hsl(var(--primary) / 0.1);
        color: hsl(var(--primary));
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .notes-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-box {
        position: relative;
        flex: 1;
        min-width: 200px;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid hsl(var(--border));
        border-radius: 0.5rem;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 0.875rem;
    }

    .search-input:focus {
        outline: none;
        border-color: hsl(var(--ring));
        box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: hsl(var(--muted-foreground));
    }

    .filter-controls {
        display: flex;
        gap: 0.75rem;
    }

    .filter-select {
        padding: 0.75rem 1rem;
        border: 1px solid hsl(var(--border));
        border-radius: 0.5rem;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 0.875rem;
        min-width: 120px;
    }

    .filter-select:focus {
        outline: none;
        border-color: hsl(var(--ring));
        box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
    }

    .heart-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.2s ease;
        color: hsl(var(--muted-foreground));
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .heart-button:hover {
        background: hsl(var(--muted) / 0.5);
        transform: scale(1.1);
    }

    .heart-button.active {
        color: hsl(var(--destructive));
    }

    .heart-button.active:hover {
        background: hsl(var(--destructive) / 0.1);
    }

    .heart-button.active svg {
        fill: currentColor;
    }

    .note-card.favorite {
        border-color: hsl(var(--destructive) / 0.3);
        background: hsl(var(--destructive) / 0.05);
    }

    .no-notes-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        background: hsl(var(--muted) / 0.5);
        border-radius: 0.75rem;
        border: 1px solid hsl(var(--border));
    }

    .no-notes-message h3 {
        color: hsl(var(--foreground));
        margin-bottom: 1rem;
    }

    .no-notes-message p {
        color: hsl(var(--muted-foreground));
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: hsl(var(--card));
        margin: 5% auto;
        padding: 0;
        border: 1px solid hsl(var(--border));
        border-radius: 0.75rem;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid hsl(var(--border));
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: hsl(var(--foreground));
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: hsl(var(--muted-foreground));
        padding: 0.25rem;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: hsl(var(--muted));
        color: hsl(var(--foreground));
    }

    .note-form {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        color: hsl(var(--foreground));
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid hsl(var(--border));
        border-radius: 0.5rem;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        font-size: 0.875rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: hsl(var(--ring));
        box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .form-help {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: hsl(var(--muted-foreground));
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        color: hsl(var(--foreground));
    }

    .checkbox-label input[type="checkbox"] {
        margin-right: 0.75rem;
        width: 1rem;
        height: 1rem;
        accent-color: hsl(var(--primary));
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid hsl(var(--border));
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-primary {
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }

    .btn-primary:hover {
        background: hsl(var(--primary) / 0.9);
    }

    .btn-secondary {
        background: hsl(var(--secondary));
        color: hsl(var(--secondary-foreground));
        border: 1px solid hsl(var(--border));
    }

    .btn-secondary:hover {
        background: hsl(var(--secondary) / 0.9);
    }

    @media (max-width: 768px) {
        .notes-container {
            padding: 1rem;
        }
        
        .notes-title {
            font-size: 2rem;
        }
        
        .notes-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .notes-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .notes-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-controls {
            justify-content: space-between;
        }
        
        .modal-content {
            width: 95%;
            margin: 2% auto;
        }
        
        .modal-actions {
            flex-direction: column;
        }
        
        .modal-actions .btn {
            width: 100%;
        }
    }
</style>

<script>
    // Global variables
    let notes = [];
    let filteredNotes = [];
    let availableTags = [];

    // Initialize the page
    (async () => {
        await loadNotes();
        await loadTags();
        setupEventListeners();
        setupFormEventListeners();
    })();

    // Load all notes from API
    async function loadNotes() {
        try {
            const response = await fetch('{{ url_for_prefix("/api/user/notes") }}', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load notes');
            }
            
            const data = await response.json();
            notes = data.notes || [];
            filteredNotes = [...notes];
            displayNotes();
        } catch (error) {
            console.error('Error loading notes:', error);
            displayError('Failed to load notes. Please try again.');
        }
    }

    // Load available tags
    async function loadTags() {
        try {
            const response = await fetch('{{ url_for_prefix("/api/user/tags") }}', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load tags');
            }
            
            const data = await response.json();
            availableTags = data.tags || [];
            updateTagFilter();
        } catch (error) {
            console.error('Error loading tags:', error);
        }
    }

    // Update tag filter dropdown
    function updateTagFilter() {
        const tagFilter = document.getElementById('tag-filter');
        tagFilter.innerHTML = '<option value="">All Tags</option>';
        
        availableTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            tagFilter.appendChild(option);
        });
    }

    // Display notes in the grid
    function displayNotes() {
        const notesGrid = document.getElementById('notes-grid');
        
        if (filteredNotes.length === 0) {
            notesGrid.innerHTML = `
                <div class="no-notes-message">
                    <h3>No notes found</h3>
                    <p>Create your first note to get started!</p>
                </div>
            `;
            return;
        }

        notesGrid.innerHTML = filteredNotes.map(note => createNoteCard(note)).join('');
    }

    // Create a note card HTML
    function createNoteCard(note) {
        const createdDate = new Date(note.created).toLocaleDateString();
        const isFavorite = note.is_favorite;
        const favoriteClass = isFavorite ? 'favorite' : '';
        
        // Get a preview of the content (first 200 characters)
        const preview = note.content.length > 200 
            ? note.content.substring(0, 200) + '...' 
            : note.content;
        
        return `
            <div class="note-card ${favoriteClass}" data-note-id="${note.id}">
                <div class="note-header">
                    <h3 class="note-title">${escapeHtml(note.title)}</h3>
                    <div class="note-header-right">
                        <span class="note-date">${createdDate}</span>
                        <button class="heart-button ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${note.id}')" title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <p class="note-preview">${escapeHtml(preview)}</p>
                <div class="note-tags">
                    ${note.tags.length > 0 
                        ? note.tags.map(tag => `<span class="note-tag">${escapeHtml(tag)}</span>`).join('')
                        : '<span class="note-tag" style="opacity: 0.5;">No tags</span>'
                    }
                </div>
            </div>
        `;
    }

    // Setup event listeners
    function setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', debounce(filterNotes, 300));

        // Tag filter
        const tagFilter = document.getElementById('tag-filter');
        tagFilter.addEventListener('change', filterNotes);

        // Favorite filter
        const favoriteFilter = document.getElementById('favorite-filter');
        favoriteFilter.addEventListener('change', filterNotes);
    }

    // Filter notes based on search and filters
    function filterNotes() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const selectedTag = document.getElementById('tag-filter').value;
        const favoriteFilter = document.getElementById('favorite-filter').value;

        filteredNotes = notes.filter(note => {
            const matchesSearch = !searchTerm || 
                note.title.toLowerCase().includes(searchTerm) || 
                note.content.toLowerCase().includes(searchTerm);
            
            const matchesTag = !selectedTag || note.tags.includes(selectedTag);
            
            const matchesFavorite = favoriteFilter === '' || 
                (favoriteFilter === 'true' && note.is_favorite) ||
                (favoriteFilter === 'false' && !note.is_favorite);

            return matchesSearch && matchesTag && matchesFavorite;
        });

        displayNotes();
    }

    // Create new note
    function createNewNote() {
        // Reset form and show modal
        document.getElementById('note-form').reset();
        document.getElementById('modal-title').textContent = 'Create New Note';
        document.getElementById('save-note-btn').textContent = 'Save Note';
        document.getElementById('save-note-btn').onclick = (event) => {
            event.preventDefault();
            handleSaveNote();
        };
        document.getElementById('note-modal').style.display = 'block';
        
        // Focus on title input
        setTimeout(() => {
            document.getElementById('note-title-input').focus();
        }, 100);
    }

    // Save note (create or update)
    async function saveNote(noteData, noteId = null) {
        try {
            const url = noteId ? window.urlPrefix + `/api/user/notes/${noteId}` : window.urlPrefix + '/api/user/notes';
            const method = noteId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(noteData)
            });

            if (!response.ok) {
                throw new Error('Failed to save note');
            }

            const data = await response.json();
            
            if (noteId) {
                // Update existing note in the array
                const index = notes.findIndex(note => note.id === noteId);
                if (index !== -1) {
                    notes[index] = data.note;
                }
            } else {
                // Add new note to the array
                notes.unshift(data.note);
            }

            // Refresh the display
            await loadTags();
            filterNotes();
            
        } catch (error) {
            console.error('Error saving note:', error);
            alert('Failed to save note. Please try again.');
        }
    }


    // Toggle favorite status
    async function toggleFavorite(noteId) {
        const note = notes.find(n => n.id === noteId);
        if (!note) return;

        const noteData = {
            is_favorite: !note.is_favorite
        };

        try {
            const response = await fetch(`${window.urlPrefix}/api/user/notes/${noteId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(noteData)
            });

            if (!response.ok) {
                throw new Error('Failed to update note');
            }

            const data = await response.json();
            
            // Update note in the array
            const index = notes.findIndex(n => n.id === noteId);
            if (index !== -1) {
                notes[index] = data.note;
            }

            // Refresh the display
            filterNotes();
            
        } catch (error) {
            console.error('Error updating note:', error);
            alert('Failed to update note. Please try again.');
        }
    }


    // Handle form submission for saving notes
    async function handleSaveNote(noteId = null) {
        const title = document.getElementById('note-title-input').value.trim();
        const content = document.getElementById('note-content-input').value.trim();
        const tagsInput = document.getElementById('note-tags-input').value.trim();
        const isFavorite = document.getElementById('note-favorite-input').checked;

        if (!title || !content) {
            alert('Please fill in both title and content.');
            return;
        }

        const tags = tagsInput 
            ? tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag)
            : [];

        const noteData = {
            title: title,
            content: content,
            tags: tags,
            is_favorite: isFavorite
        };

        await saveNote(noteData, noteId);
        closeModal();
    }

    // Close modal
    function closeModal() {
        document.getElementById('note-modal').style.display = 'none';
        document.getElementById('note-form').reset();
    }

    // Setup form event listeners
    function setupFormEventListeners() {
        // Form submission
        document.getElementById('note-form').addEventListener('submit', (e) => {
            e.preventDefault();
            // Get the current onclick handler and execute it
            const saveBtn = document.getElementById('save-note-btn');
            if (saveBtn.onclick) {
                saveBtn.onclick(e);
            }
        });

        // Close modal when clicking outside
        document.getElementById('note-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('note-modal')) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    }

    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function displayError(message) {
        const notesGrid = document.getElementById('notes-grid');
        notesGrid.innerHTML = `
            <div class="no-notes-message">
                <h3>Error</h3>
                <p>${message}</p>
            </div>
        `;
    }
</script>
